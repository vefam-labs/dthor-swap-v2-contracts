Copied from v2-core